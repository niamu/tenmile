<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>automated tests</title>
    <script src="lib/emitter.js"></script>
    <script src="lib/gameboy.js"></script>
    <script src="lib/msgpack.js"></script>
    <script src="js/quotes.js"></script>
    <style>
      body {
        white-space: pre;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    (See console for detailed messages.)
  </body>
  <script>
    "use strict";

    const TEST_GAME_URL = "https://bonsaiden.github.io/Tuff.gb/roms/game.gb";

    async function _digest(obj) {
      let bytes = msgpack.serialize(obj);
      let digest = await crypto.subtle.digest("SHA-1", bytes);
      let str = "";
      for (let byte of new Uint8Array(digest)) {
        str += byte.toString(16).padStart(2, "0");
      }
      return str;
    }
    
    function _crapSnap(gameboy) {
      let crap = new Map();
      for(let k in gameboy) {
        crap.set(k, (""+gameboy[k]));
      }
      return crap;
    }

    async function _play(gameboy, steps) {
      for (let step of steps) {
        if (step.run) {
          for (let i = 0; i < step.run; i++) {
            gameboy.run();
          }
        }
        if (step.joy) {
          gameboy.JoyPadEvent(step.joy[0], step.joy[1]);
        }
      }
    }

    function _assert(cond, msg) {
      if (!cond) {
        throw msg;
      }
    }

    const TESTS = {
      gbSaveRestoreDeterminism: async function() {
        /*
        From other experimentation, I know that the JoyPad propery of GameBoyCore is stateful but not currently saved in savestates. However, that isnt' the explanation for the problem reproduced here.
        */

        let response = await fetch(TEST_GAME_URL);
        let buffer = await response.arrayBuffer();

        let canvas = document.createElement("canvas");
        canvas.setAttribute("width", 160);
        canvas.setAttribute("height", 144);

        let opts = {};
        window.debug = () => {};
        let gameboy = GameBoyCore(canvas, new Uint8Array(buffer), opts);
        gameboy.stopEmulator = 1;
        gameboy.start();

        _play(gameboy, [{ run: 150 }]);

        let crapA = _crapSnap(gameboy);
        let stateA = gameboy.saveState();
        
        let _CPUCyclesTotalCurrent = gameboy.CPUCyclesTotalCurrent;
        let _totalLinesPassed = gameboy.totalLinesPassed;
        let _JoyPad = gameboy.JoyPad;
        let stateDigestA = await _digest(stateA);

        console.log(gameboy.CPUTicks, gameboy);
        _play(gameboy, [
          { joy: [4, true] },
          { run: 10 },
          { joy: [4, false] },
          { run: 100 }
        ]);
        console.log(gameboy.CPUTicks, gameboy);

        let stateB = gameboy.saveState();
        let stateDigestB = await _digest(stateB);
        _assert(
          stateDigestA != stateDigestB,
          "initial state should not match progressed state"
        );

        gameboy.returnFromState(stateA);
        gameboy.CPUCyclesTotalCurrent = _CPUCyclesTotalCurrent;
        gameboy.totalLinesPassed = _totalLinesPassed;
        gameboy.JoyPad = _JoyPad;
        let crapC = _crapSnap(gameboy);
        let stateC = gameboy.saveState();
        let stateDigestC = await _digest(stateC);
        _assert(
          stateDigestA == stateDigestC,
          "restoration to initial state should yield identical saved state"
        );
        
        for(let k of crapA.keys()) {
          if(crapA.get(k) != crapC.get(k)) {
            console.log('crapSnap mismatch on key', k, crapA.get(k), '->', crapC.get(k));
          }
        }

        console.log(gameboy.CPUTicks, gameboy);
        _play(gameboy, [
          { joy: [4, true] },
          { run: 10 },
          { joy: [4, false] },
          { run: 100 }
        ]);
        console.log(gameboy.CPUTicks, gameboy);

        let stateD = gameboy.saveState();
        let stateDigestD = await _digest(stateD);
        for (let i in stateB) {
          if (stateB[i].toString() != stateD[i].toString()) {
            console.warn("mismatch at savestate index", i);
          }
        }
        _assert(
          stateDigestB == stateDigestD,
          "two identically progressed states should equal"
        );

        gameboy.returnFromState(stateA);
        _play(gameboy, [
          { joy: [4, true] },
          { run: 10 },
          { joy: [4, false] },
          { run: 100 }
        ]);
        let stateZ = gameboy.saveState();
        let stateDigestZ = await _digest(stateZ);
        _assert(
          stateDigestD == stateDigestZ,
          "three identically progressed states should equal"
        );

        gameboy.returnFromState(stateA);

        _play(gameboy, [
          { joy: [4, true] },
          { run: 10 },
          { joy: [4, false] },
          { run: 100 },
          { joy: [0, true] },
          { run: 10 },
          { joy: [0, false] },
          { run: 100 }
        ]);

        let stateE = gameboy.saveState();
        let stateDigestE = await _digest(stateE);
        _assert(
          stateDigestB != stateDigestE,
          "two differently progressed states should not be equal"
        );
      }
    };

    (async function runAllTests() {
      for (let [name, test] of Object.entries(TESTS)) {
        console.log(`Running ${name}...`);
        let okay = false;
        try {
          let result = await test();
          console.log("Result:", result);
          okay = true;
        } catch (exception) {
          console.error(exception);
        }
        document.body.innerText += `Test "${name}" ${
          okay ? "passed" : "failed"
        }.\n`;
      }
      document.body.innerText += "Done with tests.";
    })();
  </script>
</html>
