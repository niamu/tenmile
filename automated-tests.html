<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>automated tests</title>
    <script src="lib/pako.min.js" defer></script>
    <script src="lib/emitter.js"></script>
    <script src="lib/gameboy.js"></script>
    <script src="lib/UPNG.js"></script>
    <script src="lib/jszip.min.js"></script>
    <script src="lib/msgpack.js"></script>
    <script src="js/quotes.js"></script>
    <style>
      body {
        white-space: pre;
        font-family: monospace;
      }
    </style>
  </head>
  <body>(See browser console for messages.)</body>
  <script>
      "use strict";

      const TEST_GAME_URL = "https://bonsaiden.github.io/Tuff.gb/roms/game.gb";

      const TESTS = {
        gbSaveRestore: async function() {
          let response = await fetch(TEST_GAME_URL);
          let buffer = await response.arrayBuffer();
          
          let canvas = document.createElement("canvas");
          canvas.setAttribute("width", 160);
          canvas.setAttribute("height", 144);
          
          let opts = {};
          window.debug = ()=>{};
          let gameboy = GameBoyCore(canvas, new Uint8Array(buffer), opts);
          gameboy.stopEmulator = 1;
          gameboy.start();
          
          for(let i = 0; i < 100; i++) {
            gameboy.run();
          }
          
          gameboy.JoyPadEvent(4, true);
          
          for(let i = 0; i < 10; i++) {
            gameboy.run();
          }
          
          gameboy.JoyPadEvent(4, false);
          
          
          for(let i = 0; i < 100; i++) {
            gameboy.run();
          }
          
          let state = msgpack.serialize(gameboy.saveState());
          let stateDigest = await crypto.subtle.digest('SHA-1', state);
          return stateDigest;
          
          /*
          Gb test: (save/restore determinism)
    - load rom
    - construct
    - run
    - joypadevent
    - run
    - save A
    - check A
    - run
    - joypadevent
    - run
    - save B
    - check B
    - restore
    - check A
    - run
    - joypadevent
    - run
    - save B
    - check B
          */

        }
    };

    (async function runAllTests() {
      for(let [name, test] of Object.entries(TESTS)) {
        console.log(`Running ${name}...`);
        let okay = false;
        try {
          let result = await test();
          console.log('Result:', result);
          okay = true;
        } catch(exception) {
          console.error(exception)
        }
        document.body.innerText += `Test "${name}" ${(okay?'passed':'failed')}.\n`;
      }
    })();
  </script>
</html>
