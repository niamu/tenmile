<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Quote Visualizer</title>
    <script src="lib/jszip-3.6.0.min.js"></script>
    <script src="lib/pako-2.0.3.min.js"></script>
    <script src="lib/UPNG-2.2.0.js"></script>
    <script src="lib/msgpack-1.0.3.js"></script>
    <script src="lib/marked-2.1.3.min.js"></script>
    <script src="js/quotes.js"></script>
    <style>
      #dropzone {
        min-height: 200px;
        min-width: 200px;
        width: min-content;
        border: 3px solid green;
      }

      img {
        border: 1px solid black;
      }
    </style>
  </head>
  <body>
    <h1>
      Quote Visualizer
    </h1>
    <div id="inputWidget">
      <label for="fileUpload"
        >Select playable quote file (or plain ROM file):</label
      >
      <input id="fileUpload" type="file" />
    </div>

    <div id="analysis"></div>
  </body>
  <script defer>
    "use strict";

    window.gtag = function() {};
    
    const buttonNames = ["Right", "Left", "Up", "Down", "A", "B", "Select", "Start"]
    
    const colormap = [
      [255, 255, 255, 255], // 0 is special, white, others are rainbow
      [0, 2, 132, 255],
      [0, 4, 133, 255],
      [0, 6, 135, 255],
      [0, 8, 136, 255],
      [0, 9, 137, 255],
      [0, 11, 138, 255],
      [0, 13, 140, 255],
      [0, 15, 141, 255],
      [0, 17, 142, 255],
      [0, 19, 143, 255],
      [0, 21, 144, 255],
      [0, 23, 146, 255],
      [0, 24, 147, 255],
      [0, 26, 148, 255],
      [0, 28, 149, 255],
      [0, 30, 151, 255],
      [0, 32, 152, 255],
      [0, 34, 153, 255],
      [0, 36, 154, 255],
      [0, 38, 155, 255],
      [0, 39, 157, 255],
      [0, 41, 158, 255],
      [0, 43, 159, 255],
      [0, 45, 160, 255],
      [0, 47, 161, 255],
      [0, 49, 163, 255],
      [0, 51, 164, 255],
      [0, 53, 165, 255],
      [0, 54, 166, 255],
      [0, 56, 168, 255],
      [0, 58, 169, 255],
      [0, 60, 170, 255],
      [0, 63, 171, 255],
      [0, 66, 173, 255],
      [0, 69, 174, 255],
      [0, 72, 175, 255],
      [0, 75, 177, 255],
      [0, 78, 178, 255],
      [1, 81, 179, 255],
      [1, 84, 181, 255],
      [1, 87, 182, 255],
      [1, 90, 183, 255],
      [1, 94, 185, 255],
      [1, 97, 186, 255],
      [1, 100, 187, 255],
      [1, 103, 189, 255],
      [1, 106, 190, 255],
      [1, 109, 191, 255],
      [1, 112, 193, 255],
      [1, 115, 194, 255],
      [1, 118, 195, 255],
      [2, 121, 197, 255],
      [2, 124, 198, 255],
      [2, 127, 199, 255],
      [2, 130, 201, 255],
      [2, 133, 202, 255],
      [2, 136, 203, 255],
      [2, 139, 205, 255],
      [2, 142, 206, 255],
      [2, 145, 207, 255],
      [2, 148, 209, 255],
      [2, 151, 210, 255],
      [2, 154, 211, 255],
      [3, 158, 213, 255],
      [3, 161, 214, 255],
      [3, 164, 215, 255],
      [3, 167, 216, 255],
      [3, 170, 218, 255],
      [3, 173, 219, 255],
      [3, 176, 220, 255],
      [3, 179, 222, 255],
      [3, 182, 223, 255],
      [3, 185, 224, 255],
      [3, 188, 226, 255],
      [3, 191, 227, 255],
      [3, 194, 228, 255],
      [4, 197, 230, 255],
      [4, 200, 231, 255],
      [4, 203, 232, 255],
      [4, 206, 234, 255],
      [4, 209, 235, 255],
      [4, 212, 236, 255],
      [4, 215, 238, 255],
      [4, 218, 239, 255],
      [4, 221, 240, 255],
      [4, 225, 242, 255],
      [4, 228, 243, 255],
      [4, 231, 244, 255],
      [4, 234, 246, 255],
      [5, 237, 247, 255],
      [5, 240, 248, 255],
      [5, 243, 250, 255],
      [5, 246, 251, 255],
      [5, 249, 252, 255],
      [5, 252, 254, 255],
      [5, 255, 255, 255],
      [9, 255, 251, 255],
      [13, 255, 247, 255],
      [17, 255, 243, 255],
      [21, 255, 239, 255],
      [25, 255, 235, 255],
      [29, 255, 231, 255],
      [33, 255, 227, 255],
      [37, 255, 223, 255],
      [41, 255, 219, 255],
      [45, 255, 215, 255],
      [49, 255, 210, 255],
      [53, 255, 206, 255],
      [57, 255, 202, 255],
      [61, 255, 198, 255],
      [65, 255, 194, 255],
      [68, 255, 190, 255],
      [72, 255, 186, 255],
      [76, 255, 182, 255],
      [80, 255, 178, 255],
      [84, 255, 174, 255],
      [88, 255, 170, 255],
      [92, 255, 166, 255],
      [96, 255, 162, 255],
      [100, 255, 158, 255],
      [104, 255, 154, 255],
      [108, 255, 150, 255],
      [112, 255, 146, 255],
      [116, 255, 142, 255],
      [120, 255, 138, 255],
      [124, 255, 134, 255],
      [128, 255, 130, 255],
      [132, 255, 125, 255],
      [136, 255, 121, 255],
      [140, 255, 117, 255],
      [144, 255, 113, 255],
      [148, 255, 109, 255],
      [152, 255, 105, 255],
      [156, 255, 101, 255],
      [160, 255, 97, 255],
      [164, 255, 93, 255],
      [168, 255, 89, 255],
      [172, 255, 85, 255],
      [176, 255, 81, 255],
      [180, 255, 77, 255],
      [184, 255, 73, 255],
      [188, 255, 69, 255],
      [192, 255, 65, 255],
      [195, 255, 61, 255],
      [199, 255, 57, 255],
      [203, 255, 53, 255],
      [207, 255, 49, 255],
      [211, 255, 45, 255],
      [215, 255, 40, 255],
      [219, 255, 36, 255],
      [223, 255, 32, 255],
      [227, 255, 28, 255],
      [231, 255, 24, 255],
      [235, 255, 20, 255],
      [239, 255, 16, 255],
      [243, 255, 12, 255],
      [247, 255, 8, 255],
      [251, 255, 4, 255],
      [255, 255, 0, 255],
      [255, 251, 0, 255],
      [255, 247, 0, 255],
      [255, 243, 0, 255],
      [255, 239, 0, 255],
      [255, 235, 0, 255],
      [255, 231, 0, 255],
      [254, 227, 0, 255],
      [254, 223, 0, 255],
      [254, 219, 0, 255],
      [254, 215, 0, 255],
      [254, 211, 0, 255],
      [254, 207, 0, 255],
      [254, 203, 0, 255],
      [254, 199, 0, 255],
      [254, 195, 0, 255],
      [254, 191, 0, 255],
      [254, 187, 0, 255],
      [254, 183, 0, 255],
      [254, 179, 0, 255],
      [253, 175, 0, 255],
      [253, 171, 0, 255],
      [253, 167, 0, 255],
      [253, 163, 0, 255],
      [253, 159, 0, 255],
      [253, 155, 0, 255],
      [253, 151, 0, 255],
      [253, 147, 0, 255],
      [253, 143, 0, 255],
      [253, 139, 0, 255],
      [253, 135, 0, 255],
      [253, 131, 0, 255],
      [253, 128, 0, 255],
      [252, 124, 0, 255],
      [252, 120, 0, 255],
      [252, 116, 0, 255],
      [252, 112, 0, 255],
      [252, 108, 0, 255],
      [252, 104, 0, 255],
      [252, 100, 0, 255],
      [252, 96, 0, 255],
      [252, 92, 0, 255],
      [252, 88, 0, 255],
      [252, 84, 0, 255],
      [252, 80, 0, 255],
      [251, 76, 0, 255],
      [251, 72, 0, 255],
      [251, 68, 0, 255],
      [251, 64, 0, 255],
      [251, 60, 0, 255],
      [251, 56, 0, 255],
      [251, 52, 0, 255],
      [251, 48, 0, 255],
      [251, 44, 0, 255],
      [251, 40, 0, 255],
      [251, 36, 0, 255],
      [251, 32, 0, 255],
      [251, 28, 0, 255],
      [250, 24, 0, 255],
      [250, 20, 0, 255],
      [250, 16, 0, 255],
      [250, 12, 0, 255],
      [250, 8, 0, 255],
      [250, 4, 0, 255],
      [250, 0, 0, 255],
      [246, 0, 0, 255],
      [242, 0, 0, 255],
      [239, 0, 0, 255],
      [235, 0, 0, 255],
      [231, 0, 0, 255],
      [227, 0, 0, 255],
      [223, 0, 0, 255],
      [220, 0, 0, 255],
      [216, 0, 0, 255],
      [212, 0, 0, 255],
      [208, 0, 0, 255],
      [204, 0, 0, 255],
      [200, 0, 0, 255],
      [197, 0, 0, 255],
      [193, 0, 0, 255],
      [189, 0, 0, 255],
      [185, 0, 0, 255],
      [181, 0, 0, 255],
      [178, 0, 0, 255],
      [174, 0, 0, 255],
      [170, 0, 0, 255],
      [166, 0, 0, 255],
      [162, 0, 0, 255],
      [159, 0, 0, 255],
      [155, 0, 0, 255],
      [151, 0, 0, 255],
      [147, 0, 0, 255],
      [143, 0, 0, 255],
      [139, 0, 0, 255],
      [136, 0, 0, 255],
      [132, 0, 0, 255],
      [128, 0, 0, 255]
    ];

    async function urlToROM(url) {
      let file = await fetch(url);
      let buffer = await file.arrayBuffer();
      let quote = await loadQuote(buffer);
      return quote.state[0];
    }

    async function processFile(file) {
      analysis.innerHTML = "";

      let buffer = await file.arrayBuffer();
      let dataView = new DataView(buffer);
      let isPNG = dataView.getUint32(0) == 0x89504e47;
      let isGB =
        dataView.getUint32(0x104) == 0xceed6666 &&
        dataView.getUint32(0x108) == 0xcc0d000b;

      if (isPNG) {
        let quote = await loadQuote(buffer);

        let romH = document.createElement("h2");
        romH.innerText = "Sliced ROM";
        analysis.appendChild(romH);
        drawROM(quote.state[0]);

        let maskH = document.createElement("h2");
        maskH.innerText = "ROM validity mask";
        analysis.appendChild(maskH);
        drawROM(quote.masks["ROM"]);

        let readmeH = document.createElement("h2");
        readmeH.innerText = "Readme";
        analysis.appendChild(readmeH);
        let readmeDiv = document.createElement("div");
        readmeDiv.innerHTML = marked(quote.readme);
        analysis.appendChild(readmeDiv);

        let actionsH = document.createElement("h2");
        actionsH.innerText = "Actions";
        let actionsDiv = document.createElement("div");
        debugger;
        quote.actions.forEach((actions,i) => {
          if(actions) {
            let row = document.createElement("div");
            row.innerText = "@"+i;
            for(let [button,down] of actions) {
              row.innerText += " "+(["press","release"][down|0])+ buttonNames[button];
            }
            actionsDiv.appendChild(row);
          }
        })
        analysis.appendChild(actionsDiv);
      } else if (isGB) {
        let romH = document.createElement("h2");
        romH.innerText = "ROM";
        analysis.appendChild(romH);
        drawROM(new Uint8Array(buffer));
      } else {
        alert("Unsupported file");
      }
    }

    async function drawROM(rom) {
      const WIDTH = 512;
      const BANK_SIZE = 16 * 1024; // one switchable bank of GB memory
      const STRIP_SIZE = 16; // a single strip
      const BLOCK_HEIGHT = BANK_SIZE / WIDTH;

      let banks = Math.ceil(rom.length / BANK_SIZE);
      let w = WIDTH;
      let h = (BANK_SIZE / WIDTH) * banks;

      let data = new Uint8Array(w * h * 4);
      rom.forEach((v, i) => {
        let x =
          (i % STRIP_SIZE) +
          ((STRIP_SIZE * Math.floor(i / STRIP_SIZE / BLOCK_HEIGHT)) % WIDTH);
        let y =
          (Math.floor(i / STRIP_SIZE) % BLOCK_HEIGHT) +
          BLOCK_HEIGHT * Math.floor(i / BANK_SIZE);

        let j = 512 * y + x;
        let color = colormap[v];
        data[4 * j + 0] = color[0];
        data[4 * j + 1] = color[1];
        data[4 * j + 2] = color[2];
        data[4 * j + 3] = color[3];
      });

      let png = UPNG.encode([data], w, h);
      let blob = new Blob([png], { type: "image/png" });

      let img = document.createElement("img");
      img.src = URL.createObjectURL(blob);
      document.getElementById("analysis").appendChild(img);
    }

    window.onload = async function visualize() {
      document.getElementById("fileUpload").onchange = ev => {
        for (let item of ev.target.files) {
          processFile(item);
        }
      };

      if (window.location.hash.startsWith("#drop=")) {
        let url = window.location.hash.split("=")[1];
        processFile(await fetch(url));
      }
    };
  </script>
</html>
