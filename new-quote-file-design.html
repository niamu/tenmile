<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>new quote file design</title>
    <script src="lib/pako.min.js" defer></script>
    <script src="lib/UPNG.js"></script>
    <script src="lib/jszip.min.js"></script>
    <script src="lib/msgpack.js"></script>
    <style>
      canvas {
      }
    </style>
  </head>
  <body></body>
  <script>
    (async function() {
      let buffer = await (await fetch(
        "https://cdn.glitch.com/80f5a65b-f7e3-4b40-b639-8e2c014de0ca%2F6236ed13-d5a7-4fc5-9473-8ae93b18ea08.png?v=1627504375824"
      )).arrayBuffer();
      let rgba = new Uint8Array(UPNG.toRGBA8(UPNG.decode(buffer))[0]);

      let name = "MYGAME22MYGAME22";
      let numActions = 5422;
      let sliceBytes = 1425;
      let originalBytes = 65535;

      let state = { foo: 0, bar: [5, 6, 7] };
      let rom = Uint8Array.from([0, 0, 4, 5]);
      let romMask = Uint8Array.from([0, 0, 1, 1]);
      let readme = "hello from the text file\n";

      let zip = new JSZip();
      zip.file("rom.bin", rom);
      zip.file("romMask.bin", romMask);
      zip.file("state.msgpack", msgpack.serialize(state));
      zip.file("README.md", readme);

      let zipBuffer = await zip.generateAsync({
        type: "arraybuffer",
        compression: "DEFLATE",
        compressionOptions: { level: 9 }
      });

      let font = new FontFace(
        "Early GameBoy",
        'url("https://cdn.glitch.com/80f5a65b-f7e3-4b40-b639-8e2c014de0ca%2FEarly%20GameBoy.woff?v=1627886220949")'
      );
      await font.load();
      document.fonts.add(font);

      let canvas = document.createElement("canvas");

      const borderSize = 12;

      const sw = 160;
      const sh = 144;

      canvas.setAttribute("width", sw + 2 * borderSize);
      canvas.setAttribute("height", sh + 2 * borderSize);
      document.body.appendChild(canvas);

      let ctx = canvas.getContext("2d");

      ctx.fillStyle = "#ccc";
      ctx.fillRect(0, 0, sw + 2 * borderSize, sh + 2 * borderSize);

      ctx.strokeStyle = "#444";
      ctx.strokeRect(0, 0, sw + 2 * borderSize, sh + 2 * borderSize);
      ctx.strokeRect(borderSize, borderSize, sw, sh);

      let screenshotimageData = ctx.createImageData(160, 144);
      for (let i = 0; i < rgba.length; i++) {
        screenshotimageData.data[i] = rgba[i];
      }
      let screenshotImageBitmap = await createImageBitmap(screenshotimageData);
      ctx.imageSmoothingEnabled = false;
      ctx.drawImage(screenshotImageBitmap, borderSize, borderSize, sw, sh);

      ctx.fillStyle = "#000";
      ctx.font = `${0.666 * borderSize}px "Early GameBoy"`;
      ctx.fillText(name, borderSize, 0.75 * borderSize);

      ctx.fillStyle = "#888";
      ctx.textAlign = "right";
      ctx.fillText(
        "[ 8bpp steg zip",
        sw + borderSize,
        sh + borderSize + 0.75 * borderSize
      );

      ctx.save();
      ctx.translate(borderSize + sw + 0.75 * borderSize, borderSize + sh / 2);
      ctx.rotate(-Math.PI / 2);
      ctx.textAlign = "center";
      ctx.fillText("35242 steps", 0, 0);
      ctx.restore();

      ctx.save();
      ctx.translate(0.25 * borderSize, borderSize + sh / 2);
      ctx.rotate(Math.PI / 2);
      ctx.textAlign = "center";
      ctx.fillText("12230 rom bytes", 0, 0);
      ctx.restore();

      let quoteImageData = ctx.getImageData(0,0,sw+2*borderSize,sh+2*borderSize);
      console.log(quoteImageData.data.length);
      console.log(zipBuffer);
      let imgBytes = quoteImageData.data;
      let zipBytes = new Uint8Array(zipBuffer);
      if (zipBytes.length > imgBytes.length) {
        alert('zip too big to steganographically encode into image!');
      }
      let numBytes = zipBytes.length;
      for (let i = 0; i < numBytes; i++) {
        let byte = imgBytes[i];
        byte &= 3; 
      }
      

      // TODO: get canvas into a png somewhow
      // TODO: combine with zip (stegano?)

      // TODO: let it be downloadable with a click such that filename is correct
    })();
  </script>
</html>
