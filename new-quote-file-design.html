<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>new quote file design</title>
    <script src="lib/pako.min.js" defer></script>
    <script src="lib/UPNG.js"></script>
    <script src="lib/jszip.min.js"></script>
    <script src="lib/msgpack.js"></script>
    <style>
      canvas {border: thick solid salmon; }
    </style>
  </head>
  <body></body>
  <script>
    (async function() {
      
      // This mess attempts to show how to pack data into the new quote file design
      
      let rgba = [];
      for (let i = 0; i < 144; i++) {
        for (let j = 0; j < 160; j++) {
          if (Math.floor((i + j) / 10) % 2 == 0) {
            rgba.push(0xffaa00ff);
          } else {
            rgba.push(0xaaff00ff);
          }
        }
      }

      let name = "MYGAME";
      let numActions = 5422;
      let sliceBytes = 1425;
      let originalBytes = 65535;

      let state = { foo: 0, bar: [5, 6, 7] };
      let rom = Uint8Array.from([0, 0, 4, 5]);
      let romMask = Uint8Array.from([0, 0, 1, 1]);
      let readme = "hello from the text file\n";

      let zip = new JSZip();
      zip.file("rom.bin", rom);
      zip.file("romMask.bin", romMask);
      zip.file("state.msgpack", msgpack.serialize(state));
      zip.file("README.md", readme);

      let zipBuffer = await zip.generateAsync({
        type: "arraybuffer",
        compression: "DEFLATE",
        compressionOptions: { level: 9 }
      });
      
      
      let canvas = document.createElement("canvas");
      
      
      const borderSize = 32;
      
      canvas.setAttribute("width", 160 + 2*borderSize);
      canvas.setAttribute("height", 144 + 2*borderSize);
      document.body.appendChild(canvas);
      
      
      let ctx = canvas.getContext('2d');
      ctx.fillStyle = '#aaa';
      ctx.fillRect(0,0,160+2*borderSize,144+2*borderSize);
      
      ctx.fillStyle = '#444';
      ctx.fillRect(borderSize-1,borderSize-1,160+2,144+2);
      
      let imageData = ctx.createImageData(160, 144);
      // TODO: fill imageData.data with screenshot
      ctx.putImageData(imageData,borderSize,borderSize);
      
      // TODO: write surrounding text from metadata
      
      // TODO: get canvas into a png somewhow
      // TODO: combine with zip (stegano?)
      
      // TODO: let it be downloadable with a click such that filename is correct
      
      
      
    })();
  </script>
</html>
